{% extends '/base.html.twig' %}

{% block title %}
    {{ parent() }} | Accueil
{% endblock %}

{% block body %}
    {# TODO : styliser les infos pour les positionner correctement #}
    <div class="infoLog">
        <p>Date du jour : {{ "now" |date('d/m/o') }}</p>
        <p>Participant : {{ app.user.pseudo() }}</p>
    </div>

    <h1>Filtrer les sorties</h1>

    <div class="container">
        {% include 'sorties/_filtre.html.twig' with {form: form} only %}
    </div>

    <div class="table-custom">
    <table class="table table-striped table-hover table-responsive container text-center" style="margin-top: 50px">
        <thead>
            <tr class="row">
                <th class="col-md-2">Nom de la sortie</th>
                <th class="col-md-2">Date de la sortie</th>
                <th class="col-md-1">Clôture</th>
                <th class="col-md-1">Inscrit(s)/places</th>
                <th class="col-md-1">État</th>
                <th class="col-md-1">Inscrit</th>
                <th class="col-md-2">Organisateur</th>
                <th class="col-md-2">Actions</th>
            </tr>
        </thead>
        <tbody>
        {% if sorties.count() == 0 %}
        <tr class="row">
            <td class="col-12">
                <div class="display-5 display-5-custom">Aucune sortie à afficher</div>
            </td>
        </tr>
        {% endif %}
    {% for sortie in sorties %}
        {% set today = "now" %}
        {# La condition ci-dessous sert à empêcher l'affichage d'une sortie en cours de création par un autre utilisateur #}
         {% if not (sortie.organisateur.pseudo is not same as (app.user.pseudo()) and sortie.etat.libelle == "Créée")  %}
            <tr class="row">
                <td class="col-md-2">{{ sortie.nom }}</td>
                <td class="col-md-2">{{ sortie.dateHeureDebut | date('d/m/o H\\Hi' ) }}</td>
                <td class="col-md-1">{{ sortie.dateLimiteInscription | date('d/m/o')}}</td>
                <td class="col-md-1">{{ sortie.participants|length }}/{{ sortie.nbInscriptionMax }}</td>
                <td class="col-md-1">
                    {% if sortie.etat.libelle == "Créée"%}
                        {% set etat = "En création" %}
                    {% endif %}
                    {% if sortie.etat.libelle == "Ouverte"%}
                        {% if sortie.participants|length == sortie.nbInscriptionMax or sortie.dateLimiteInscription|date('d/m/o') < today|date('d/m/o') %}
                            {% set etat = "Fermé" %}
                        {% else %}
                            {% set etat = "Ouvert" %}
                        {% endif %}
                    {% endif %}
                    {% if sortie.etat.libelle == "Activité en cours"%}
                        {% set etat = "En cours" %}
                    {% endif %}
                    {% if sortie.etat.libelle == "Passée"%}
                        {% set etat = "Terminé" %}
                    {% endif %}
                    {% if sortie.etat.libelle == "Annulée"%}
                        {% set etat = "Annulé" %}
                    {% endif %}
                    {{ etat }}
                </td>
                <td class="col-md-1">
                    {% set inscrit = false %}
                    {% for participant in sortie.participants %}
                        {% if participant.pseudo is same as app.user.pseudo %}
                            {% set inscrit = true %}
                            X
                    {% endif %}
                    {% endfor %}
                </td>
                <td class="col-md-2">{{ sortie.organisateur.pseudo}}</td>
                <td class="col-md-2">
                        {% if etat == "En création" %}
                            <a href="{{ path('sorties_modifier', {'id': sortie.id}) }}">Modifier </a>
                            -
                            <a href=""> Publier</a>
                        {% else %}
                            <a href="#">Afficher </a>
                        {% endif %}
                        {% if etat == "Ouvert" %}
                            -
                            {% if sortie.organisateur.pseudo is same as app.user.pseudo() %}
                                <a href="#">Annuler</a>
                            {% elseif inscrit %}
                                <a href="{{ path('sorties_desistement', {'id': sortie.id}) }}">Se désister</a>
                            {% else %}
                                <a href="{{ path('sorties_inscription', {'id': sortie.id}) }}">S'inscrire</a>
                            {% endif %}
                        {% endif %}
                    {% if etat == "Fermé" %}
                        {% if inscrit %}
                            -
                            <a href="{{ path('sorties_desistement', {'id': sortie.id}) }}">Se désister</a>
                            {% endif %}
                        {% if sortie.organisateur.pseudo is same as app.user.pseudo() %}
                            -
                            <a href="#">Annuler</a>
                        {% endif %}
                    {% endif %}
                </td>
            </tr>
        {% endif %}
    {% endfor %}
        </tbody>
    </table>
    </div>
    <a class="btn" href="{{ path('sorties_creer') }}">Créer une sortie</a>
{% endblock %}


